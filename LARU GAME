<!doctype html>
<html lang="en-AU" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LARU Assessment Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    * { box-sizing: border-box; }
    html, body { width: 100%; margin: 0; padding: 0; }
    #app { width: 100%; }
    .game-container { width: 100%; min-height: 400px; }
    .game-content { width: 100%; padding-bottom: 40px; }
    .progress-bar { height: 6px; background: rgba(79, 195, 247, 0.3); border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #4fc3f7 0%, #2196f3 100%); transition: width 0.5s ease; }
    .assessment-bar { height: 8px; border-radius: 4px; background: linear-gradient(90deg, var(--bar-color) var(--bar-width), #2a2a3e var(--bar-width)); transition: background 0.5s ease; }
    .fade-in { animation: fadeIn 0.5s ease-in forwards; }
    .slide-in { animation: slideIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .phase-hidden { display: none; }
    .phase-visible { display: block; }
    .gradient-text { background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .risk-badge { padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .risk-low { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
    .risk-medium { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .risk-high { background: rgba(248, 113, 113, 0.2); color: #f87171; }
    .decision-option { background: rgba(79, 195, 247, 0.08); border: 2px solid rgba(79, 195, 247, 0.3); border-radius: 8px; padding: 10px 14px; cursor: pointer; transition: all 0.3s ease; }
    .decision-option:hover { background: rgba(79, 195, 247, 0.15); border-color: #4fc3f7; transform: translateX(4px); }
    .decision-option.selected { background: rgba(79, 195, 247, 0.25); border-color: #4fc3f7; border-width: 2px; }
    .game-card { background: rgba(30, 30, 50, 0.95); border: 2px solid #4fc3f7; border-radius: 12px; padding: 14px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
    .compact-section { margin-bottom: 10px; }
    .scrollable-panel { max-height: 500px; overflow-y: auto; overflow-x: hidden; }
    .scrollbar-thin::-webkit-scrollbar { width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: rgba(30, 30, 50, 0.5); border-radius: 4px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(79, 195, 247, 0.5); border-radius: 4px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(79, 195, 247, 0.7); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-center; z-index: 1000; animation: fadeIn 0.3s ease-in; }
    .modal-content { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 3px solid #f87171; border-radius: 16px; padding: 24px; max-width: 600px; width: 90%; max-height: 600px; overflow-y: auto; box-shadow: 0 8px 32px rgba(248, 113, 113, 0.3); animation: slideIn 0.4s ease-out; margin: auto; }
    .restart-button { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #f87171 0%, #dc2626 100%); color: white; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(248, 113, 113, 0.4); transition: all 0.3s ease; z-index: 999; font-size: 24px; }
    .restart-button:hover { transform: scale(1.1) rotate(180deg); box-shadow: 0 6px 20px rgba(248, 113, 113, 0.6); }
    .warning-pulse { animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .avatar-option { background: rgba(79, 195, 247, 0.08); border: 2px solid rgba(79, 195, 247, 0.3); border-radius: 12px; padding: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .avatar-option:hover { background: rgba(79, 195, 247, 0.15); border-color: #4fc3f7; transform: scale(1.05); }
    .avatar-option.selected { background: rgba(79, 195, 247, 0.25); border-color: #4fc3f7; border-width: 3px; box-shadow: 0 0 20px rgba(79, 195, 247, 0.4); }
    .player-avatar-image { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid #4fc3f7; }
    .avatar-fallback { width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 64px; background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%); border: 2px solid #4fc3f7; }
    .loading-screen { display: flex; align-items: center; justify-content: center; min-height: 400px; }
    .spinner { border: 4px solid rgba(79, 195, 247, 0.3); border-top: 4px solid #4fc3f7; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="h-full">
  <div id="app" class="h-full w-full">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
      <div class="text-center">
        <div class="spinner mx-auto mb-4"></div>
        <p class="text-white text-lg">Loading Assessment...</p>
      </div>
    </div>
    
    <!-- Game Container (hidden until loaded) -->
    <div id="game-container" class="game-container phase-hidden" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
      <!-- Header -->
      <header id="game-header" role="banner" class="py-3 px-4 phase-hidden" style="background: linear-gradient(135deg, #0f3460 0%, #16213e 100%); border-bottom: 2px solid #4fc3f7;">
        <div class="max-w-7xl mx-auto">
          <div class="flex items-center justify-between mb-2">
            <h1 class="text-xl font-bold gradient-text">LARU Simulation</h1>
            <div class="text-sm text-gray-400">Level <span id="current-level">1 of 15</span></div>
          </div>
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
          </div>
        </div>
      </header>
      
      <!-- Main Game Area -->
      <main role="main" class="game-content scrollbar-thin">
        <!-- Restart Button -->
        <button id="restart-btn" class="restart-button" title="Restart Game">‚Üª</button>
        
        <!-- Welcome Screen -->
        <div id="welcome-section" class="max-w-3xl mx-auto px-4 py-8 flex items-center justify-center" style="min-height: 100%;">
          <div class="game-card text-center">
            <div class="mb-6">
              <h1 class="text-4xl font-bold mb-3 gradient-text">Welcome to LARU - The Game!</h1>
              <p class="text-lg text-gray-300 mb-2">Local-Area Assessment and Referral Unit Simulation</p>
              <p class="text-sm text-gray-400">Test your knowledge in patient assessment and complex care coordination</p>
            </div>
            
            <div class="max-w-md mx-auto mb-6 p-4 rounded-lg" style="background: rgba(79, 195, 247, 0.1);">
              <label class="block text-center text-white font-semibold mb-3">Choose Your Avatar</label>
              <div class="grid grid-cols-2 gap-4 max-w-xs mx-auto">
                <div class="avatar-option" data-avatar="male">
                  <img src="https://i.imgur.com/LIkZl3G.png" alt="Male Paramedic" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-5xl\'>üë®‚Äç‚öïÔ∏è</div>';">
                </div>
                <div class="avatar-option" data-avatar="female">
                  <img src="https://i.imgur.com/c1tFA77.png" alt="Female Paramedic" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-5xl\'>üë©‚Äç‚öïÔ∏è</div>';">
                </div>
              </div>
            </div>
            
            <div class="max-w-md mx-auto mb-6 p-4 rounded-lg" style="background: rgba(79, 195, 247, 0.1);">
              <input type="text" id="learner-name" placeholder="Enter your name" class="w-full px-4 py-2 rounded-lg text-white text-center font-medium" style="background: rgba(30, 30, 50, 0.8); border: 2px solid rgba(79, 195, 247, 0.3);" maxlength="30">
            </div>
            
            <div class="mb-4">
              <button id="start-game-btn" class="px-8 py-3 rounded-lg font-bold text-base text-black transition-all duration-300 hover:transform hover:-translate-y-1 opacity-50 cursor-not-allowed" style="background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%);" disabled>
                Start your shift üöë
              </button>
            </div>
          </div>
        </div>
        
        <!-- Dynamic Content Sections (populated from JSON) -->
        <div id="dynamic-sections"></div>
        
        <!-- Soft-Fail Modal -->
        <div id="soft-fail-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content" id="soft-fail-content"></div>
        </div>
        
        <!-- Hard-Fail Modal -->
        <div id="hard-fail-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content" id="hard-fail-content"></div>
        </div>
      </main>
    </div>
  </div>
  
  <script>
    // ===== CONFIGURATION =====
    const CONFIG = {
      jsonUrl: 'https://raw.githubusercontent.com/THEGAMEFORLARRY/laru-assessment-data/refs/heads/main/questions.json',
      cacheBusting: true
    };
    
    // ===== GLOBAL DATA STORAGE =====
    let scenarioData = null;
    let introQuestions = [];
    let mainQuestions = [];
    let softFailMessages = {};
    let hardFailMessages = {};
    let initialMetrics = {};
    
    // ===== PLAYER AVATARS =====
    const PLAYER_AVATARS = {
      male: { url: 'https://i.imgur.com/LIkZl3G.png', emoji: 'üë®‚Äç‚öïÔ∏è', label: 'Male Paramedic' },
      female: { url: 'https://i.imgur.com/c1tFA77.png', emoji: 'üë©‚Äç‚öïÔ∏è', label: 'Female Paramedic' }
    };
    
    // ===== SESSION STATS =====
    let sessionStats = {
      sessionAttempts: 0,
      sessionStartTime: Date.now(),
      sessionSoftFails: 0,
      sessionHardFails: 0
    };
    
    // ===== GAME STATE =====
    let gameState = {
      currentQuestion: 0,
      selectedOption: null,
      totalScore: 0,
      answers: [],
      playerAvatar: null,
      learnerName: '',
      metrics: {},
      previousMetrics: {},
      softFailTriggered: false,
      pendingSelectedOption: null,
      hardFailed: false,
      scenarioShown: false,
      introQuestionScores: [],
      attemptStartTime: null,
      attemptEndTime: null,
      softFailCount: 0,
      hardFailCount: 0
    };
    
    // ===== UTILITY FUNCTIONS =====
    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      
      if (hours > 0) return `${hours}h ${minutes}m ${seconds}s`;
      if (minutes > 0) return `${minutes}m ${seconds}s`;
      return `${seconds}s`;
    }
    
    // ===== LOAD JSON DATA =====
    async function loadQuestionData() {
      try {
        let url = CONFIG.jsonUrl;
        if (CONFIG.cacheBusting) {
          const timestamp = new Date().getTime();
          const separator = url.includes('?') ? '&' : '?';
          url = `${url}${separator}v=${timestamp}`;
        }
        
        console.log('Attempting to load JSON from:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const jsonData = await response.json();
        console.log('JSON loaded successfully:', jsonData);
        
        // Store data globally
        scenarioData = jsonData.scenario;
        introQuestions = jsonData.introQuestions || [];
        mainQuestions = jsonData.mainQuestions || [];
        softFailMessages = jsonData.softFailMessages || {};
        hardFailMessages = jsonData.hardFailMessages || {};
        initialMetrics = jsonData.initialMetrics || { trust: 30, rapport: 30, clinical: 0, support: 0, risk: 20 };
        
        // Initialize game state with metrics
        gameState.metrics = { ...initialMetrics };
        gameState.previousMetrics = { ...initialMetrics };
        
        // Hide loading screen
        document.getElementById('loading-screen').style.display = 'none';
        
        // Show game container
        const gameContainer = document.getElementById('game-container');
        gameContainer.classList.remove('phase-hidden');
        gameContainer.style.display = 'block';
        
        // Build dynamic sections
        buildDynamicSections();
        
        // Show welcome screen
        document.getElementById('welcome-section').style.display = 'flex';
        
        return true;
      } catch (error) {
        console.error('Error loading question data:', error);
        
        document.getElementById('loading-screen').innerHTML = `
          <div class="text-center max-w-md mx-auto px-4">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <p class="text-white text-lg mb-2">Failed to load assessment data</p>
            <p class="text-gray-400 text-sm mb-4">Error: ${error.message}</p>
            <button onclick="location.reload()" class="mt-4 px-6 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600">
              Retry
            </button>
          </div>
        `;
        return false;
      }
    }
    
    // ===== BUILD DYNAMIC SECTIONS FROM JSON =====
    function buildDynamicSections() {
      const container = document.getElementById('dynamic-sections');
      
      container.innerHTML = `
        <!-- Dispatch Briefing Section -->
        <div id="dispatch-section" class="max-w-3xl mx-auto px-4 py-8 flex items-center justify-center phase-hidden" style="min-height: 100%;">
          <div class="game-card" style="max-width: 600px; width: 100%;">
            <div class="text-center mb-4">
              <h2 class="text-2xl font-bold text-white mb-2">üìª You have been dispatched</h2>
            </div>
            <div class="scrollable-panel scrollbar-thin p-4 rounded-lg mb-4" style="background: rgba(79, 195, 247, 0.1); border-left: 4px solid #4fc3f7;">
              <h3 class="text-lg font-bold text-white mb-3">Dispatch Information</h3>
              <div class="space-y-3 text-sm">
                <div class="p-3 rounded" style="background: rgba(30, 30, 50, 0.6);">
                  <div class="text-gray-400 text-xs mb-1">INCIDENT TYPE</div>
                  <div class="font-bold text-white text-base" id="dispatch-incident-type"></div>
                </div>
                <div class="p-3 rounded" style="background: rgba(30, 30, 50, 0.6);">
                  <div class="text-gray-400 text-xs mb-1">CALLER</div>
                  <div class="font-medium text-white" id="dispatch-caller"></div>
                </div>
                <div class="p-3 rounded" style="background: rgba(30, 30, 50, 0.6);">
                  <div class="text-gray-400 text-xs mb-1">MDT INFORMATION</div>
                  <div class="font-medium text-white">
                    <div class="space-y-1" id="dispatch-mdt-info"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="text-center">
              <button id="acknowledge-dispatch-btn" class="px-8 py-3 rounded-lg font-bold text-base text-black transition-all duration-300 hover:transform hover:-translate-y-1" style="background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%); box-shadow: 0 4px 12px rgba(79, 195, 247, 0.4);">
                Acknowledge & Respond üöë
              </button>
            </div>
          </div>
        </div>

        <!-- Arrival Scene Section -->
        <div id="arrival-section" class="max-w-3xl mx-auto px-4 py-8 flex items-center justify-center phase-hidden" style="min-height: 100%;">
          <div class="game-card" style="max-width: 600px; width: 100%;">
            <div class="text-center mb-4">
              <h2 class="text-2xl font-bold text-white mb-2">üè° Arriving at Scene</h2>
            </div>
            <div class="scrollable-panel scrollbar-thin p-4 rounded-lg mb-4" style="background: rgba(79, 195, 247, 0.1); border-left: 4px solid #4fc3f7;">
              <h3 class="text-lg font-bold text-white mb-3">Initial Observations</h3>
              <div class="space-y-3 text-sm text-gray-300">
                <p id="arrival-description"></p>
                <div class="p-3 rounded" style="background: rgba(30, 30, 50, 0.6);">
                  <div class="text-gray-400 text-xs mb-2">PROPERTY EXTERIOR</div>
                  <ul class="space-y-1 ml-3" id="arrival-exterior"></ul>
                </div>
                <div class="p-3 rounded" style="background: rgba(30, 30, 50, 0.6);">
                  <div class="text-gray-400 text-xs mb-2">INITIAL IMPRESSIONS</div>
                  <p id="arrival-impressions"></p>
                </div>
              </div>
            </div>
            <div class="text-center">
              <div class="flex items-center justify-center gap-4">
                <button id="enter-property-btn" class="px-8 py-3 rounded-lg font-bold text-base text-black transition-all duration-300 hover:transform hover:-translate-y-1" style="background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%); box-shadow: 0 4px 12px rgba(79, 195, 247, 0.4);">
                  Approach the front door ‚Üí
                </button>
                <button id="return-vehicle-btn" class="px-8 py-3 rounded-lg font-bold text-base text-white transition-all duration-300 hover:transform hover:-translate-y-1" style="background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); box-shadow: 0 4px 12px rgba(74, 85, 104, 0.4); border: 2px solid rgba(248, 113, 113, 0.3);">
                  Clear from scene
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Consent Confirmation Page -->
        <div id="consent-section" class="max-w-3xl mx-auto px-4 py-8 flex items-center justify-center phase-hidden" style="min-height: 100%;">
          <div class="game-card" style="max-width: 600px; width: 100%;">
            <div class="text-center mb-4">
              <h2 class="text-2xl font-bold text-white mb-2">‚úÖ Consent Obtained</h2>
            </div>
            <div class="scrollable-panel scrollbar-thin">
              <div class="p-4 rounded-lg mb-4" style="background: rgba(74, 222, 128, 0.1); border-left: 4px solid #4ade80;">
                <h3 class="text-lg font-bold text-white mb-3" id="consent-patient-name">Margaret consents to be assessed by you in her home</h3>
                <div class="space-y-3 text-sm text-gray-300">
                  <p>You have successfully established rapport through your professional approach. She understands:</p>
                  <ul class="space-y-2 ml-4">
                    <li>‚Ä¢ Your role as a LARU paramedic</li>
                    <li>‚Ä¢ The purpose of today's assessment</li>
                    <li>‚Ä¢ That she can withdraw consent at any time</li>
                    <li>‚Ä¢ How the information will be used to support her care</li>
                  </ul>
                  <p class="mt-3" id="consent-comfort">Margaret appears comfortable and ready to proceed with the comprehensive assessment.</p>
                </div>
              </div>
              <div class="p-4 rounded-lg mb-4" style="background: rgba(79, 195, 247, 0.1); border-left: 4px solid #4fc3f7;">
                <h3 class="text-lg font-bold text-white mb-3">üéØ What Happens Next</h3>
                <div class="space-y-2 text-sm text-gray-300">
                  <p>You will now conduct a <strong>comprehensive LARU assessment</strong> covering:</p>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                    <div class="p-2 rounded" style="background: rgba(30, 30, 50, 0.6);">
                      <div class="font-semibold text-white">üéØ Clinical Assessment</div>
                      <div class="text-xs">Falls risk, medication review, pain management</div>
                    </div>
                    <div class="p-2 rounded" style="background: rgba(30, 30, 50, 0.6);">
                      <div class="font-semibold text-white">üè† Environmental Safety</div>
                      <div class="text-xs">Home hazards, mobility aids, accessibility</div>
                    </div>
                    <div class="p-2 rounded" style="background: rgba(30, 30, 50, 0.6);">
                      <div class="font-semibold text-white">üß† Cognitive Function</div>
                      <div class="text-xs">Memory, decision-making capacity, orientation</div>
                    </div>
                    <div class="p-2 rounded" style="background: rgba(30, 30, 50, 0.6);">
                      <div class="font-semibold text-white">üë• Social Support</div>
                      <div class="text-xs">Family networks, isolation, community services</div>
                    </div>
                    <div class="p-2 rounded" style="background: rgba(30, 30, 50, 0.6);">
                      <div class="font-semibold text-white">üéØ Functional Capacity</div>
                      <div class="text-xs">ADLs, independence, reablement potential</div>
                    </div>
                    <div class="p-2 rounded" style="background: rgba(30, 30, 50, 0.6);">
                      <div class="font-semibold text-white">üìã Care Planning</div>
                      <div class="text-xs">MDT coordination, shared decision-making</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="text-center">
              <button id="show-scenario-btn" class="px-8 py-3 rounded-lg font-bold text-base text-black transition-all duration-300 hover:transform hover:-translate-y-1" style="background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%); box-shadow: 0 4px 12px rgba(79, 195, 247, 0.4);">
                Review Patient Details & Continue ‚Üí
              </button>
            </div>
          </div>
        </div>
        
        <div id="game-section" class="max-w-7xl mx-auto px-4 py-3 phase-hidden">
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
            <!-- Patient Sidebar -->
            <aside class="lg:col-span-1">
              <div class="game-card">
                <div class="text-center mb-3">
                  <div id="patient-avatar-container" class="mx-auto mb-2 rounded-lg overflow-hidden" style="width: 160px; height: 160px; border: 2px solid #4fc3f7;">
                    <img id="patient-avatar-img" alt="Patient" style="width: 100%; height: 100%; object-fit: cover;">
                  </div>
                  <h2 id="patient-name" class="font-bold text-base mb-1" style="color: #4fc3f7;"></h2>
                  <p id="patient-info" class="text-xs text-gray-400"></p>
                </div>
                
                <!-- Key Info -->
                <div id="patient-key-info" class="space-y-2 mb-3 text-xs"></div>
                  ${scenarioData.patientKeyInfo.map(info => `
                    <div class="p-2 rounded" style="background: rgba(79, 195, 247, 0.1);">
                      <div class="text-gray-400 mb-1">${info.label}</div>
                      <div class="font-medium text-white">${info.value}</div>
                    </div>
                  `).join('')}
                </div>

                <!-- Performance Metrics -->
                <div class="border-t pt-3" style="border-color: rgba(79, 195, 247, 0.3);">
                  <h3 class="text-xs font-semibold text-white mb-3">Performance Metrics</h3>
                  <div class="space-y-3 text-xs">
                    ${Object.keys(initialMetrics).map(key => `
                      <div>
                        <div class="flex items-center justify-between mb-1">
                          <span class="text-gray-300">${key.charAt(0).toUpperCase() + key.slice(1)}</span>
                          <span id="${key}-value" class="font-semibold" style="color: #4fc3f7;">${initialMetrics[key]}%</span>
                        </div>
                        <div class="assessment-bar" id="${key}-bar" style="--bar-color: #4fc3f7; --bar-width: ${initialMetrics[key]}%;"></div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            </aside>
            
            <!-- Main Content Area -->
            <div class="lg:col-span-3">
              <!-- Question Section -->
              <div id="question-section" class="game-card compact-section phase-hidden">
                <div class="mb-3">
                  <div class="flex items-center justify-between mb-2">
                    <h3 id="question-title" class="text-lg font-bold text-white">Assessment Question</h3>
                    <span id="question-badge" class="text-xl"></span>
                  </div>
                  <p id="question-text" class="text-sm text-gray-300"></p>
                </div>
                <div id="options-container" class="space-y-2 mb-3"></div>
                <div class="text-center">
                  <button id="submit-btn" disabled class="px-6 py-2 rounded-lg font-semibold text-sm text-black transition-all duration-300 opacity-50 cursor-not-allowed" style="background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%);">
                    Submit Answer
                  </button>
                </div>
              </div>
              
              <!-- Feedback Section -->
              <div id="feedback-section" class="game-card compact-section phase-hidden">
                <div class="flex items-start space-x-2 mb-2">
                  <span id="feedback-icon" class="text-2xl"></span>
                  <div class="flex-1">
                    <h3 class="text-base font-bold text-white mb-1">Feedback</h3>
                    <div id="feedback-content" class="text-xs text-gray-300"></div>
                  </div>
                </div>
                <div class="mt-2 p-3 rounded-lg" style="background: rgba(79, 195, 247, 0.1);">
                  <div id="metric-changes" class="text-xs space-y-1 mb-3"></div>
                  <div class="text-center">
                    <button id="next-btn" class="px-5 py-2 rounded-lg font-semibold text-sm text-black transition-all duration-300 hover:transform hover:-translate-y-1" style="background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%);">
                      <span id="next-btn-text">Next Question ‚Üí</span>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Results Section -->
              <div id="results-section" class="game-card compact-section phase-hidden">
                <h2 class="text-2xl font-bold mb-3 text-center text-white">Assessment Complete! üéâ</h2>
                <div id="results-content"></div>
                <div class="text-center mt-4">
                  <button id="play-again-btn" class="px-6 py-2 rounded-lg font-semibold text-sm text-black transition-all duration-300 hover:transform hover:-translate-y-1" style="background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%);">
                    Play Again
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // ===== GAME FUNCTIONS =====
    function selectPlayerAvatar(avatarType) {
      gameState.playerAvatar = avatarType;
      const avatarOptions = document.querySelectorAll('.avatar-option');
      avatarOptions.forEach(option => {
        if (option.dataset.avatar === avatarType) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      });
      checkStartButton();
    }
    
    function checkStartButton() {
      const nameInput = document.getElementById('learner-name');
      const startBtn = document.getElementById('start-game-btn');
      
      if (nameInput && startBtn) {
        const hasName = nameInput.value.trim().length > 0;
        const hasAvatar = gameState.playerAvatar !== null;
        
        if (hasName && hasAvatar) {
          startBtn.disabled = false;
          startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
          startBtn.disabled = true;
          startBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
    }
    
    function startGame() {
      const nameInput = document.getElementById('learner-name');
      gameState.learnerName = nameInput.value.trim();
      gameState.attemptStartTime = Date.now();
      
      document.getElementById('welcome-section').style.display = 'none';
      document.getElementById('game-header').classList.remove('phase-hidden');
      document.getElementById('game-section').classList.remove('phase-hidden');
      
      loadQuestion(0);
    }
    
    function loadQuestion(index) {
      const introCount = introQuestions.length;
      const mainCount = mainQuestions.length;
      const totalQuestions = introCount + mainCount;
      
      if (index >= totalQuestions) {
        showResults();
        return;
      }
      
      gameState.currentQuestion = index;
      gameState.selectedOption = null;
      
      let question;
if (index < introCount) {
question = introQuestions[index];
} else {
question = mainQuestions[index - introCount];
}
      document.getElementById('current-level').textContent = `${index + 1} of ${totalQuestions}`;
      document.getElementById('question-title').textContent = question.title || "Assessment Question";
      document.getElementById('question-badge').textContent = question.icon || "üìã";
      document.getElementById('question-text').textContent = question.question;
      
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      
      question.options.forEach((option, idx) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'decision-option';
        optionDiv.setAttribute('data-option-index', idx);
        optionDiv.innerHTML = `<div class="font-medium text-white text-sm">${option.text}</div>`;
        optionsContainer.appendChild(optionDiv);
      });
      
const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

      document.getElementById('question-section').classList.remove('phase-hidden');
      document.getElementById('feedback-section').classList.add('phase-hidden');
      
      updateProgress();
    }
    
    function selectOption(index) {
      gameState.selectedOption = index;
      const options = document.querySelectorAll('.decision-option');
      options.forEach((opt, idx) => {
        if (idx === index) {
          opt.classList.add('selected');
        } else {
          opt.classList.remove('selected');
        }
      });
      
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = false;
      submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    function submitAnswer() {
      if (gameState.selectedOption === null) return;
      
      const index = gameState.currentQuestion;
      const introCount = introQuestions.length;
      const question = index < introCount 
        ? introQuestions[index] 
        : mainQuestions[index - introCount];
      
      const selectedOption = question.options[gameState.selectedOption];
      
      if (index < introQuestions.length) {
        gameState.introQuestionScores[index] = selectedOption.points;
      }
      
      gameState.previousMetrics = { ...gameState.metrics };
      gameState.totalScore += selectedOption.points;
      
      // Check for hard fail
      if (selectedOption.isHardFail) {
        gameState.hardFailed = true;
        triggerHardFail(selectedOption.hardFailType || 'general');
        return;
      }
      
      // Update metrics
      updateMetrics(question, selectedOption.points);
      
      // Check for soft fail
      if (selectedOption.isSoftFail || selectedOption.triggerSoftFailModal) {
        gameState.pendingSelectedOption = selectedOption;
        triggerSoftFail(selectedOption.softFailType || 'default');
        return;
      }
      
      showFeedback(selectedOption);
    }
    
    function updateMetrics(question, pointsScored) {
      if (!question.metricImpacts) return;
      
      const performance = pointsScored / 10;
      const changeMultiplier = (performance - 0.5) * 2;
      
      Object.keys(question.metricImpacts).forEach(key => {
        const impact = question.metricImpacts[key];
        gameState.metrics[key] = Math.max(0, Math.min(100, 
          gameState.metrics[key] + (impact * changeMultiplier)
        ));
      });
      
      updateMetricBars();
    }
    
    function updateMetricBars() {
      Object.keys(gameState.metrics).forEach(key => {
        const value = Math.round(gameState.metrics[key]);
        const valueEl = document.getElementById(`${key}-value`);
        const barEl = document.getElementById(`${key}-bar`);
        
        if (valueEl) valueEl.textContent = `${value}%`;
        if (barEl) barEl.style.setProperty('--bar-width', `${value}%`);
      });
    }
    
    function showFeedback(selectedOption) {
      document.getElementById('feedback-icon').textContent = selectedOption.points >= 9 ? 'üåü' : 
                                                             selectedOption.points >= 7 ? '‚úÖ' :
                                                             selectedOption.points >= 5 ? 'üí°' : '‚ö†Ô∏è';
      document.getElementById('feedback-content').innerHTML = selectedOption.feedback;
      
      displayMetricChanges();
      
      const totalQuestions = introQuestions.length + mainQuestions.length;
      document.getElementById('next-btn-text').textContent = 
        gameState.currentQuestion === totalQuestions - 1 ? 'View Results ‚Üí' : 'Next Question ‚Üí';
      
      document.getElementById('question-section').classList.add('phase-hidden');
      document.getElementById('feedback-section').classList.remove('phase-hidden');
    }
    
    function displayMetricChanges() {
      const container = document.getElementById('metric-changes');
      let html = '';
      
      Object.keys(gameState.metrics).forEach(key => {
        const oldValue = gameState.previousMetrics[key];
        const newValue = gameState.metrics[key];
        const change = Math.round(newValue - oldValue);
        
        if (change !== 0) {
          const icon = change > 0 ? 'üìà' : 'üìâ';
          const sign = change > 0 ? '+' : '';
          const color = change > 0 ? '#4ade80' : '#f87171';
          
          html += `
            <div class="flex items-center justify-between">
              <span class="text-gray-300">${icon} ${key.charAt(0).toUpperCase() + key.slice(1)}</span>
              <span class="font-semibold" style="color: ${color};">${sign}${change}</span>
            </div>
          `;
        }
      });
      
      container.innerHTML = html || '<div class="text-gray-400 text-center">No metric changes</div>';
    }
    
    function triggerSoftFail(type) {
      gameState.softFailCount++;
      sessionStats.sessionSoftFails++;
      
      const message = softFailMessages[type] || softFailMessages.default || {
        title: 'Alert',
        content: 'Please review your approach',
        warning: 'Consider alternative strategies',
        footer: 'Reflect on best practices'
      };
      
      document.getElementById('soft-fail-content').innerHTML = `
        <div class="text-center mb-4">
          <div class="text-5xl mb-3 warning-pulse">‚ö†Ô∏è</div>
          <h2 class="text-2xl font-bold mb-2" style="color: #f87171;">${message.title}</h2>
          <div class="text-sm text-gray-400">${message.subtitle || ''}</div>
        </div>
        <div class="p-4 rounded-lg mb-4" style="background: rgba(248, 113, 113, 0.1); border: 2px solid rgba(248, 113, 113, 0.3);">
          ${message.content}
        </div>
        <div class="p-3 rounded-lg mb-4 text-sm" style="background: rgba(251, 191, 36, 0.1); border-left: 4px solid #fbbf24;">
          ${message.warning}
        </div>
        <div class="text-center">
          <button onclick="acknowledgeSoftFail()" class="px-6 py-2 rounded-lg font-semibold text-sm text-white transition-all duration-300" style="background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);">
            Acknowledge & Continue
          </button>
        </div>
        <p class="text-xs text-center text-gray-500 mt-3">${message.footer}</p>
      `;
      
      document.getElementById('soft-fail-modal').style.display = 'flex';
    }
    
    function acknowledgeSoftFail() {
      document.getElementById('soft-fail-modal').style.display = 'none';
      if (gameState.pendingSelectedOption) {
        showFeedback(gameState.pendingSelectedOption);
        gameState.pendingSelectedOption = null;
      }
    }
    
    function triggerHardFail(type) {
      gameState.hardFailCount++;
      sessionStats.sessionHardFails++;
      
      const message = hardFailMessages[type] || hardFailMessages.general || {
        icon: 'üö®',
        title: 'Assessment Terminated',
        content: '<p>The assessment cannot continue.</p>'
      };
      
      document.getElementById('hard-fail-content').innerHTML = `
        <div class="text-center mb-4">
          <div class="text-6xl mb-3 warning-pulse">${message.icon}</div>
          <h2 class="text-2xl font-bold mb-2" style="color: #dc2626;">${message.title}</h2>
          <div class="text-sm text-gray-400">${message.subtitle || ''}</div>
        </div>
        <div class="p-4 rounded-lg mb-4" style="background: rgba(220, 38, 38, 0.15); border: 2px solid rgba(220, 38, 38, 0.5);">
          ${message.content}
        </div>
        <div class="text-center">
          <button onclick="restartGame()" class="px-6 py-2 rounded-lg font-semibold text-sm text-white transition-all duration-300" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);">
            Let's try again
          </button>
        </div>
      `;
      
      document.getElementById('hard-fail-modal').style.display = 'flex';
    }
    
    function nextQuestion() {
      gameState.currentQuestion++; 
      document.getElementById('feedback-section').classList.add('phase-hidden');
      loadQuestion(gameState.currentQuestion);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function updateProgress() {
      const totalQuestions = introQuestions.length + mainQuestions.length;
      const progress = ((gameState.currentQuestion + 1) / totalQuestions) * 100;
      document.getElementById('progress-fill').style.width = `${progress}%`;
    }
    
    function showResults() {
      gameState.attemptEndTime = Date.now();
      const attemptDuration = gameState.attemptEndTime - gameState.attemptStartTime;
      sessionStats.sessionAttempts++;
      
      const maxScore = (introQuestions.length + mainQuestions.length) * 10;
      const percentage = (gameState.totalScore / maxScore) * 100;
      
      let grade, performance, feedback;
      if (percentage >= 90) {
        grade = 'A+'; performance = 'Outstanding';
        feedback = '<strong>Outstanding Performance!</strong> Excellent work across all domains.';
      } else if (percentage >= 80) {
        grade = 'A'; performance = 'Excellent';
        feedback = '<strong>Excellent Work!</strong> Strong competency demonstrated.';
      } else if (percentage >= 70) {
        grade = 'B'; performance = 'Good';
        feedback = '<strong>Good Performance!</strong> Solid understanding shown.';
      } else if (percentage >= 60) {
        grade = 'C'; performance = 'Satisfactory';
        feedback = '<strong>Satisfactory Progress.</strong> Continue developing skills.';
      } else {
        grade = 'D'; performance = 'Needs Development';
        feedback = '<strong>Development Needed.</strong> Review key concepts.';
      }
      
      document.getElementById('results-content').innerHTML = `
        <div class="grid grid-cols-3 gap-2 mb-3">
          <div class="text-center p-3 rounded-lg" style="background: rgba(79, 195, 247, 0.1);">
            <div class="text-3xl mb-1">üéØ</div>
            <div class="text-2xl font-bold mb-1" style="color: #4fc3f7;">${gameState.totalScore}/${maxScore}</div>
            <div class="text-xs text-gray-400">Total Score</div>
          </div>
          <div class="text-center p-3 rounded-lg" style="background: rgba(79, 195, 247, 0.1);">
            <div class="text-3xl mb-1">‚≠ê</div>
            <div class="text-xl font-bold mb-1" style="color: #4fc3f7;">${grade}</div>
            <div class="text-xs text-gray-400">Grade</div>
          </div>
          <div class="text-center p-3 rounded-lg" style="background: rgba(79, 195, 247, 0.1);">
            <div class="text-3xl mb-1">üìä</div>
            <div class="text-sm font-bold mb-1" style="color: #4fc3f7;">${performance}</div>
            <div class="text-xs text-gray-400">Performance</div>
          </div>
        </div>
        <div class="text-sm text-gray-300 mb-3 p-3 rounded-lg" style="background: rgba(79, 195, 247, 0.1);">
          ${feedback}
        </div>
        <div class="mb-3 p-3 rounded-lg" style="background: rgba(251, 191, 36, 0.1);">
          <div class="text-xs font-semibold text-white mb-2">üìä Session Statistics</div>
          <div class="grid grid-cols-3 gap-2 text-xs">
            <div class="text-center p-2 rounded" style="background: rgba(30, 30, 50, 0.6);">
              <div class="text-gray-400 mb-1">Attempts</div>
              <div class="font-bold text-white">${sessionStats.sessionAttempts}</div>
            </div>
            <div class="text-center p-2 rounded" style="background: rgba(30, 30, 50, 0.6);">
              <div class="text-gray-400 mb-1">Duration</div>
              <div class="font-bold text-white">${formatTime(attemptDuration)}</div>
            </div>
            <div class="text-center p-2 rounded" style="background: rgba(30, 30, 50, 0.6);">
              <div class="text-gray-400 mb-1">Session Time</div>
              <div class="font-bold text-white">${formatTime(Date.now() - sessionStats.sessionStartTime)}</div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('question-section').classList.add('phase-hidden');
      document.getElementById('feedback-section').classList.add('phase-hidden');
      document.getElementById('results-section').classList.remove('phase-hidden');
    }
    
    function restartGame() {
      gameState = {
        currentQuestion: 0,
        selectedOption: null,
        totalScore: 0,
        answers: [],
        playerAvatar: null,
        learnerName: '',
        metrics: { ...initialMetrics },
        previousMetrics: { ...initialMetrics },
        softFailTriggered: false,
        pendingSelectedOption: null,
        hardFailed: false,
        scenarioShown: false,
        introQuestionScores: [],
        attemptStartTime: null,
        attemptEndTime: null,
        softFailCount: 0,
        hardFailCount: 0
      };
      
      document.getElementById('soft-fail-modal').style.display = 'none';
      document.getElementById('hard-fail-modal').style.display = 'none';
      document.getElementById('learner-name').value = '';
      
      const avatarOptions = document.querySelectorAll('.avatar-option');
      avatarOptions.forEach(opt => opt.classList.remove('selected'));
      
      updateMetricBars();
      
      document.getElementById('game-header').classList.add('phase-hidden');
      document.getElementById('game-section').classList.add('phase-hidden');
      document.getElementById('results-section').classList.add('phase-hidden');
      document.getElementById('welcome-section').style.display = 'flex';
      
      checkStartButton();
    }
    
    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', async function() {
      // Load JSON data first
      const loaded = await loadQuestionData();
      if (!loaded) return;
      
      // Avatar selection
      document.addEventListener('click', function(e) {
        const avatarOption = e.target.closest('.avatar-option');
        if (avatarOption) {
          selectPlayerAvatar(avatarOption.dataset.avatar);
        }
        
        const option = e.target.closest('.decision-option');
        if (option) {
          selectOption(parseInt(option.dataset.optionIndex));
        }
      });
      
      // Name input
      const nameInput = document.getElementById('learner-name');
      if (nameInput) nameInput.addEventListener('input', checkStartButton);
      
      // Buttons
      const startBtn = document.getElementById('start-game-btn');
      if (startBtn) startBtn.addEventListener('click', startGame);
      
      const restartBtn = document.getElementById('restart-btn');
      if (restartBtn) restartBtn.addEventListener('click', restartGame);
      
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) submitBtn.addEventListener('click', submitAnswer);
      
      const nextBtn = document.getElementById('next-btn');
      if (nextBtn) nextBtn.addEventListener('click', nextQuestion);
      
      const playAgainBtn = document.getElementById('play-again-btn');
      if (playAgainBtn) playAgainBtn.addEventListener('click', restartGame);
    });
  </script>
</body>
</html>
